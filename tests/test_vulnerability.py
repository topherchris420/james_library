import sys
import unittest
from pathlib import Path

# Add rlm path relative to this file
# tests/test_vulnerability.py -> repo_root/rlm-main/rlm-main
REPO_ROOT = Path(__file__).resolve().parent.parent
RLM_PATH = REPO_ROOT / "rlm-main" / "rlm-main"

if str(RLM_PATH) not in sys.path:
    sys.path.insert(0, str(RLM_PATH))

try:
    from rlm.environments.local_repl import LocalREPL
except ImportError:
    LocalREPL = None

class TestLocalREPLVulnerability(unittest.TestCase):
    def test_vulnerability_fixed(self):
        """
        Verify that __import__ and open are REMOVED from SAFE_BUILTINS.
        This test confirms the fix.
        """
        if LocalREPL is None:
            self.fail("Could not import LocalREPL. Ensure rlm-main/rlm-main/rlm/environments/local_repl.py exists.")

        builtins = LocalREPL.SAFE_BUILTINS
        self.assertNotIn("__import__", builtins, "__import__ should NOT be in SAFE_BUILTINS")
        self.assertNotIn("open", builtins, "open should NOT be in SAFE_BUILTINS")
        self.assertNotIn("classmethod", builtins, "classmethod should NOT be in SAFE_BUILTINS")

        # Ensure safe functions are still there
        self.assertIn("print", builtins, "print should be in SAFE_BUILTINS")
        self.assertIn("Exception", builtins, "Exception should be in SAFE_BUILTINS")

if __name__ == "__main__":
    unittest.main()
